var J=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var g=(n,t,e)=>(J(n,t,"read from private field"),e?e.call(n):t.get(n)),v=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},G=(n,t,e,i)=>(J(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e);var{max:X,min:I}=Math;function S(n,t){return I(n<0?X(0,t+n):n,t-1)}function d(n,t,e){if(n.length==0||t==0&&e==n.length)return n;if(n.data){let i=new b;return i.off=t+n.off,i.length=e,i.data=n.data,Object.freeze(i),i}else{let{left:i,right:r}=n;if(!(i instanceof b&&r instanceof b))throw new TypeError;if(t>i.length)return d(r,t-i.length,e);if(t+e<i.length)return d(i,t,e);let s=new b,o=i.length-t;return s.left=d(i,t,o),s.right=d(r,0,e-o),s.length=e,s}}function it(n,t){let e=new b;return e.left=n,e.right=t,e.length=t.length+n.length,e}function C(...n){let t=new b;return t.data=n,t.length=n.length,t}var b=class n{constructor(){this.length=0;this.off=0}subarray(t,e){return t=S(t,this.length),e=I(this.length-t,e),d(this,t,e)}unshift(...t){return t.length<=0?this:C(...t).concat(this)}push(...t){return t.length<=0?this:this.concat(C(...t))}concat(t){return it(this,t)}insert(t,...e){return t=S(t,this.length),t==0?this.unshift(...e):t==this.length?this.push(...e):d(this,0,t).concat(d(this,t,this.length-t).unshift(...e))}delete(t,e){t=S(t,this.length);let i=t+e,r=t==0,s=i>=this.length;return r&&s?Q:r?d(this,i,this.length-i):s?d(this,0,t):d(this,0,t).concat(d(this,i,this.length-i))}splice(t,e,...i){t=S(t,this.length);let r=t+e,s=t==0,o=r>=this.length;return s&&o?Q:s?d(this,r,this.length-r).unshift(...i):o?d(this,0,t).push(...i):d(this,0,t).push(...i).concat(d(this,r,this.length-r))}set(t,e){return this.splice(t,1,e)}at(t){let e=this;if(t<0){if(t+=e.length,t<0)return}else if(t>=e.length)return;for(;e.left instanceof n;){let{left:i,right:r}=e;i.length>t?e=i:(e=r,t-=i.length)}if(!e.data)throw new Error;return e.data[t+e.off]}forEach(t){let e=0;function i(r){if(r.data)for(let s=r.off,o=s+r.length;s<o;s++)t(r.data[s],e++);else{if(!(r.left instanceof n&&r.right instanceof n))throw new TypeError;i(r.left),i(r.right)}}i(this)}every(t){let e=0,i=!1;function r(s){if(s.data){for(let o=s.off,a=o+s.length;o<a;o++)if(t(s.data[o],e++)==!1){i=!0;return}}else{if(!(s.left instanceof n&&s.right instanceof n))throw new TypeError;r(s.left),i||r(s.right)}}return r(this),!i}forEachInRange(t,e,i){t=S(t,this.length),e=I(this.length-t,e);let r=t,s=!1;function o(a,l,f){if(l!=f)if(a.data){let h=a.off,u=h+f;for(h+=l;h<u;h++)if(i(a.data[h],r++)==O){s=!0;return}}else{if(!(a.left instanceof n&&a.right instanceof n))throw new TypeError;let h=a.left,u=a.right,c=h.length;l>=c?o(u,l-c,f-c):f<=c?o(h,l,f):(o(h,l,c),s||o(u,0,f-c))}}o(this,t,t+e)}forEachInRangeReversed(t,e,i){t=S(t,this.length)+1;let r=X(t-e,0),s=t,o=!1;function a(l,f,h){if(f!=h)if(l.data){for(f+=l.off,h+=l.off-1;h>=f;h--)if(i(l.data[h],s--)==O){o=!0;return}}else{if(!(l.left instanceof n&&l.right instanceof n))throw new TypeError;let u=l.left,c=l.right,p=u.length;f>=p?a(c,f-p,h-p):h<=p?a(u,f,h):(a(c,0,h-p),o||a(u,f,p))}}a(this,r,t)}map(t){let e=[];e.length=this.length;let i=0;function r(s){if(s.data)for(let o=s.off,a=o+s.length;o<a;o++)e[i++]=t(s.data[o],o);else{if(!(s.left instanceof n&&s.right instanceof n))throw new TypeError;r(s.left),r(s.right)}}return r(this),C(...e)}flat(){let t=[];t.length=this.length;let e=0;function i(r){if(r.data)for(let s=r.off,o=s+r.length;s<o;s++)t[e++]=r.data[s];else{if(!(r.left instanceof n&&r.right instanceof n))throw new TypeError;i(r.left),i(r.right)}}return i(this),C(...t)}sort(t){let e=this.flat();return e.data.sort(t),e}},Q=C(),O=Symbol("Stop");var A=class{constructor(t,e){this.name=t,this.children=e}style(t){return this._style=t,this}attr(t){return this._attr=t,this}on(t){return this._events=t,this}ref(t){return this._ref=t,this}render(t){var i;let e=document.createElement(this.name);if(this.dom=e,this._events)for(let r in this._events){let s=this._events[r];r==="unmount"?t._addDestroyCallback(s):e.addEventListener(r,s)}if(this._attr)for(let r in this._attr){let s=this._attr[r];typeof s=="function"?t._watch(_(()=>{e.setAttribute(r,s())})):s instanceof m||s instanceof E?t._watch(_(()=>{e.setAttribute(r,s.v)})):e.setAttribute(r,s)}if(this._style)for(let r in this._style){let s=r,o=this._style[s];typeof o=="function"?t._watch(_(()=>{e.style[s]=o()})):o instanceof m||o instanceof E?t._watch(_(()=>{e.style[s]=o.v})):e.style[s]=o}if(this.children)for(let r of this.children)if(typeof r=="string"){let s=document.createTextNode(r);e.appendChild(s)}else if(typeof r=="function"){let s=document.createTextNode("");t._watch(_(()=>s.nodeValue=r())),e.appendChild(s)}else if(r instanceof E||r instanceof m){let s=document.createTextNode("");t._watch(_(()=>s.nodeValue=r.v)),e.appendChild(s)}else e.appendChild(r.render(t));return(i=this._ref)==null||i.call(this,e),e}},q=new Set,L=new Set,H=!1;function ot(){q.forEach(n=>n.v),L.forEach(n=>n()),q.clear(),L.clear(),H=!1}function tt(n){H||(H=!0,requestAnimationFrame(ot)),typeof n=="function"?L.add(n):q.add(n)}var k,W,F=class{constructor(t,e){v(this,k,new D);v(this,W,[]);this._whenDestroy=[];g(this,k).callback=tt,this.dom=e.render(this),t==null||t.appendChild(this.dom)}_watch(t){g(this,W).push(t),g(this,k).watch(t)}_addDestroyCallback(t){this._whenDestroy.push(t)}_destroy(){g(this,W).forEach(t=>g(this,k).unwatch(t)),this._whenDestroy.forEach(t=>t())}};k=new WeakMap,W=new WeakMap;function at(n,t,e){if(e.length=0,t.length=0,n.length<1)return e;function i(a,l){for(let f=t.length;f<a;f++)t.push(-1);t[a]=l}let r=0,s=n.length;for(;r<s&&n[r]==-1;r++);for(e[0]=r;r<s;r++){let a=n[r];if(a==-1)continue;let l=e[e.length-1];if(n[l]<a){i(r,l),e.push(r);continue}let f=0,h=e.length-1,u;for(;f<h;)u=f+h>>1,n[e[u]]<a?f=u+1:h=u;let c=f;a<n[e[c]]&&(c>0&&i(r,e[c-1]),e[c]=r)}r=e.length;let o=e[e.length-1];if(o>n.length)return e;for(;r-- >0;)e[r]=n[o],o=t[o];return e}var Y=[],Z=[],$=[],V=[],R,j,P=class extends A{constructor(e,i,r){super(e);v(this,R,new Map);v(this,j,new Map);this.list=i,this.f=r}render(e){let i=super.render(e),r=this.list,s=g(this,R),o=this.f,a=g(this,j);function l(){let h=Y;h.length=0;let u=r.v;u.forEach(y=>{let T=s.get(y);typeof T=="number"?(s.set(y,-1),h.push(T)):h.push(-1)}),V.length=0;let c=V;i.childNodes.forEach(y=>c.push(y)),s.forEach((y,T)=>{y!=-1&&(a.get(T)._destroy(),a.delete(T),s.delete(T),i.removeChild(c[y]))});let p=at(h,Z,$),U=0;u.forEach((y,T)=>{let B=h[T],K=p[U];if(B==-1){let M=new F(void 0,o(y));a.set(y,M),T==u.length-1?i.appendChild(M.dom):i.insertBefore(M.dom,c[K])}else B==K?U++:i.insertBefore(c[B],c[K]);s.set(y,T)}),Y.length=0,Z.length=0,$.length=0,V.length=0}let f=z(()=>{tt(l)});return f.watch(r),e._addDestroyCallback(()=>{f.unwatch(r),g(this,j).forEach(h=>h._destroy())}),l(),i}};R=new WeakMap,j=new WeakMap;var N=class extends A{constructor(e){super("");this._node=e,this._ele=e.v;let i=()=>{var s;let r=e.v;if(this._ele=r,this.name=r.name,this._events=r._events,this._attr=r._attr,this._style=r._style,this._ref=r._ref,this.children=r.children,(s=this._root)==null||s._destroy(),this._root=new F(void 0,r),this.dom){let o=this.dom.parentNode;o&&o.replaceChild(this._root.dom,this.dom)}this.dom=r.dom};this._watcher=z(i),this._watcher.watch(e),i()}render(e){return e._addDestroyCallback(()=>{var i;(i=this._root)==null||i._destroy(),this._watcher.unwatch(this._node)}),this.dom}};function ht(n,...t){return new A(n,t)}function lt(n,t,e){return new P(n,t,e)}function ft(n,t,e){let i=new WeakMap;return new P(n,_(()=>{let s=t.v;return s.forEach((o,a)=>{let l=i.get(o);l?l.v=a:i.set(o,et(a))}),s}),s=>e(i.get(s),s))}function ct(n){return typeof n=="function"?new N(_(n)):new N(n)}var w;function nt(n){var i;let t=n._Consumer;for(let r of t)if(typeof r!="number"){if(r==w)throw new Error;r._Dirty||(r._Dirty=!0,nt(r))}let e=n._Watchers;e&&(e instanceof Array?e.forEach(r=>{var s;return(s=r._Func)==null?void 0:s.call(r,n)}):(i=e._Func)==null||i.call(e,n))}var x,E=class{constructor(t){this._Consumer=[];v(this,x,void 0);G(this,x,t),this.v=t}get v(){return w&&w._GetCallback(this),g(this,x)}set v(t){if(g(this,x)!=t){G(this,x,t);try{nt(this)}catch(e){throw new Error("Detected cycle in computations.")}}}};x=new WeakMap;function rt(n){if(!(n instanceof m)||!n._Dirty)return;let t=n._Producer;t.length=0;let e=w;w=n;try{n._v=n._Func(),n._Err=void 0}catch(i){n._Err=i}n._Dirty=!1,w=e}var m=class{constructor(t){this._Consumer=[];this._Dirty=!0;this._Producer=[];this._Func=t}_GetCallback(t){let e=t._Consumer;e.indexOf(this)<0&&(e.push(this),this._Producer.push(t))}get v(){if(w&&w._GetCallback(this),rt(this),this._Err)throw this._Err;return this._v}get error(){return this._Err}get computation(){return this._Func}};function st(n){if(!(n instanceof m))return;let t=n._Producer;for(let e of t){let i=e._Consumer.indexOf(n);e._Consumer.splice(i,1),n instanceof m&&!e._Watchers&&e._Consumer.length==0&&st(e)}t.length=0}var D=class{watch(t){let e=t._Watchers;if(!e)t._Watchers=this;else if(e instanceof Array){if(e.indexOf(this)>-1)return;e.push(this)}else e!=this&&(t._Watchers=[this,e]);t instanceof m&&rt(t)}unwatch(t){let e=t._Watchers;if(e){if(e instanceof Array){let i=e.indexOf(this);if(i>-1&&e.splice(i,1),e.length>0)return}else t._Watchers=void 0;st(t)}}set callback(t){this._Func=typeof t=="function"?t:void 0}get callback(){return this._Func}};function et(n){return new E(n)}function _(n){return new m(n)}function z(n){let t=new D;return t.callback=n,t}export{m as Compute,lt as ForEach,ft as ForIn,E as State,O as Stop,D as Watcher,_ as compute,ct as dynNode,ht as h,C as makeArr,F as root,et as state,z as watcher};
//# sourceMappingURL=index.js.map
