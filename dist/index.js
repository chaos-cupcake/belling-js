var J=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var y=(r,t,e)=>(J(r,t,"read from private field"),e?e.call(r):t.get(r)),v=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},M=(r,t,e,s)=>(J(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var{max:X,min:G}=Math;function S(r,t){return G(r<0?X(0,t+r):r,t-1)}function d(r,t,e){if(r.length==0||t==0&&e==r.length)return r;if(r.data){let s=new w;return s.off=t+r.off,s.length=e,s.data=r.data,Object.freeze(s),s}else{let{left:s,right:n}=r;if(!(s instanceof w&&n instanceof w))throw new TypeError;if(t>s.length)return d(n,t-s.length,e);if(t+e<s.length)return d(s,t,e);let i=new w,o=s.length-t;return i.left=d(s,t,o),i.right=d(n,0,e-o),i.length=e,i}}function it(r,t){let e=new w;return e.left=r,e.right=t,e.length=t.length+r.length,e}function C(...r){let t=new w;return t.data=r,t.length=r.length,t}var w=class r{constructor(){this.length=0;this.off=0}subarray(t,e){return t=S(t,this.length),e=G(this.length-t,e),d(this,t,e)}unshift(...t){return t.length<=0?this:C(...t).concat(this)}push(...t){return t.length<=0?this:this.concat(C(...t))}concat(t){return it(this,t)}insert(t,...e){return t=S(t,this.length),t==0?this.unshift(...e):t==this.length?this.push(...e):d(this,0,t).concat(d(this,t,this.length-t).unshift(...e))}delete(t,e){t=S(t,this.length);let s=t+e,n=t==0,i=s>=this.length;return n&&i?Q:n?d(this,s,this.length-s):i?d(this,0,t):d(this,0,t).concat(d(this,s,this.length-s))}splice(t,e,...s){t=S(t,this.length);let n=t+e,i=t==0,o=n>=this.length;return i&&o?Q:i?d(this,n,this.length-n).unshift(...s):o?d(this,0,t).push(...s):d(this,0,t).push(...s).concat(d(this,n,this.length-n))}set(t,e){return this.splice(t,1,e)}at(t){let e=this;if(t<0){if(t+=e.length,t<0)return}else if(t>=e.length)return;for(;e.left instanceof r;){let{left:s,right:n}=e;s.length>t?e=s:(e=n,t-=s.length)}if(!e.data)throw new Error;return e.data[t+e.off]}forEach(t){let e=0;function s(n){if(n.data)for(let i=n.off,o=i+n.length;i<o;i++)t(n.data[i],e++);else{if(!(n.left instanceof r&&n.right instanceof r))throw new TypeError;s(n.left),s(n.right)}}s(this)}every(t){let e=0,s=!1;function n(i){if(i.data){for(let o=i.off,a=o+i.length;o<a;o++)if(t(i.data[o],e++)==!1){s=!0;return}}else{if(!(i.left instanceof r&&i.right instanceof r))throw new TypeError;n(i.left),s||n(i.right)}}return n(this),!s}forEachInRange(t,e,s){t=S(t,this.length),e=G(this.length-t,e);let n=t,i=!1;function o(a,l,f){if(l!=f)if(a.data){let h=a.off,u=h+f;for(h+=l;h<u;h++)if(s(a.data[h],n++)==I){i=!0;return}}else{if(!(a.left instanceof r&&a.right instanceof r))throw new TypeError;let h=a.left,u=a.right,c=h.length;l>=c?o(u,l-c,f-c):f<=c?o(h,l,f):(o(h,l,c),i||o(u,0,f-c))}}o(this,t,t+e)}forEachInRangeReversed(t,e,s){t=S(t,this.length)+1;let n=X(t-e,0),i=t,o=!1;function a(l,f,h){if(f!=h)if(l.data){for(f+=l.off,h+=l.off-1;h>=f;h--)if(s(l.data[h],i--)==I){o=!0;return}}else{if(!(l.left instanceof r&&l.right instanceof r))throw new TypeError;let u=l.left,c=l.right,p=u.length;f>=p?a(c,f-p,h-p):h<=p?a(u,f,h):(a(c,0,h-p),o||a(u,f,p))}}a(this,n,t)}map(t){let e=[];e.length=this.length;let s=0;function n(i){if(i.data)for(let o=i.off,a=o+i.length;o<a;o++)e[s++]=t(i.data[o],o);else{if(!(i.left instanceof r&&i.right instanceof r))throw new TypeError;n(i.left),n(i.right)}}return n(this),C(...e)}flat(){let t=[];t.length=this.length;let e=0;function s(n){if(n.data)for(let i=n.off,o=i+n.length;i<o;i++)t[e++]=n.data[i];else{if(!(n.left instanceof r&&n.right instanceof r))throw new TypeError;s(n.left),s(n.right)}}return s(this),C(...t)}sort(t){let e=this.flat();return e.data.sort(t),e}},Q=C(),I=Symbol("Stop");var A=class{constructor(t,e){this.name=t,this.children=e}style(t){return this._style=t,this}attr(t){return this._attr=t,this}on(t){return this._events=t,this}ref(t){return this._ref=t,this}render(t){var s;let e=document.createElement(this.name);if(this.dom=e,this._events)for(let n in this._events){let i=this._events[n];n==="unmount"?t._addDestroyCallback(i):e.addEventListener(n,i)}if(this._attr)for(let n in this._attr){let i=this._attr[n];typeof i=="function"?t._watch(_(()=>{e.setAttribute(n,i())})):i instanceof m||i instanceof E?t._watch(_(()=>{e.setAttribute(n,i.v)})):e.setAttribute(n,i)}if(this._style)for(let n in this._style){let i=n,o=this._style[i];typeof o=="function"?t._watch(_(()=>{e.style[i]=o()})):o instanceof m||o instanceof E?t._watch(_(()=>{e.style[i]=o.v})):e.style[i]=o}if(this.children)for(let n of this.children)if(typeof n=="string"){let i=document.createTextNode(n);e.appendChild(i)}else if(typeof n=="function"){let i=document.createTextNode("");t._watch(_(()=>i.nodeValue=n())),e.appendChild(i)}else if(n instanceof E||n instanceof m){let i=document.createTextNode("");t._watch(_(()=>i.nodeValue=n.v)),e.appendChild(i)}else e.appendChild(n.render(t));return(s=this._ref)==null||s.call(this,e),e}},V=new Set,q=new Set,H=!1;function ot(){q.forEach(r=>r()),V.forEach(r=>r.v),V.clear(),q.clear(),H=!1}function tt(r){H||(H=!0,requestAnimationFrame(ot)),typeof r=="function"?q.add(r):V.add(r)}var k,N,F=class{constructor(t,e){v(this,k,new j);v(this,N,[]);this._whenDestroy=[];y(this,k).callback=tt,this.dom=e.render(this),t==null||t.appendChild(this.dom)}_watch(t){y(this,N).push(t),y(this,k).watch(t)}_addDestroyCallback(t){this._whenDestroy.push(t)}_destroy(){y(this,k).unwatch(),this._whenDestroy.forEach(t=>t())}};k=new WeakMap,N=new WeakMap;function at(r,t,e){if(e.length=0,t.length=0,r.length<1)return e;function s(a,l){for(let f=t.length;f<a;f++)t.push(-1);t[a]=l}let n=0,i=r.length;for(;n<i&&r[n]==-1;n++);for(e[0]=n;n<i;n++){let a=r[n];if(a==-1)continue;let l=e[e.length-1];if(r[l]<a){s(n,l),e.push(n);continue}let f=0,h=e.length-1,u;for(;f<h;)u=f+h>>1,r[e[u]]<a?f=u+1:h=u;let c=f;a<r[e[c]]&&(c>0&&s(n,e[c-1]),e[c]=n)}n=e.length;let o=e[e.length-1];if(o>r.length)return e;for(;n-- >0;)e[n]=r[o],o=t[o];return e}var Y=[],Z=[],$=[],O=[],R,W,D=class extends A{constructor(e,s,n){super(e);v(this,R,new Map);v(this,W,new Map);this.list=s,this.f=n}render(e){let s=super.render(e),n=this.list,i=y(this,R),o=this.f,a=y(this,W);function l(){let h=Y;h.length=0;let u=n.v;u.forEach(g=>{let T=i.get(g);typeof T=="number"?(i.set(g,-1),h.push(T)):h.push(-1)}),O.length=0;let c=O;s.childNodes.forEach(g=>c.push(g)),i.forEach((g,T)=>{g!=-1&&(a.get(T)._destroy(),a.delete(T),i.delete(T),s.removeChild(c[g]))});let p=at(h,Z,$),U=0;u.forEach((g,T)=>{let L=h[T],B=p[U];if(L==-1){let K=new F(void 0,o(g));a.set(g,K),T==u.length-1?s.appendChild(K.dom):s.insertBefore(K.dom,c[B])}else L==B?U++:s.insertBefore(c[L],c[B]);i.set(g,T)}),Y.length=0,Z.length=0,$.length=0,O.length=0}let f=z(()=>{tt(l)});return f.watch(n),e._addDestroyCallback(()=>{f.unwatch(),y(this,W).forEach(h=>h._destroy())}),l(),s}};R=new WeakMap,W=new WeakMap;var P=class extends A{constructor(e){super("");this._node=e,this._ele=e.v;let s=()=>{var i;let n=e.v;if(this._ele=n,this.name=n.name,this._events=n._events,this._attr=n._attr,this._style=n._style,this._ref=n._ref,this.children=n.children,(i=this._root)==null||i._destroy(),this._root=new F(void 0,n),this.dom){let o=this.dom.parentNode;o&&o.replaceChild(this._root.dom,this.dom)}this.dom=n.dom};this._watcher=z(s),this._watcher.watch(e),s()}render(e){return e._addDestroyCallback(()=>{var s;(s=this._root)==null||s._destroy(),this._watcher.unwatch()}),this.dom}};function ht(r,...t){return new A(r,t)}function lt(r,t,e){return new D(r,t,e)}function ft(r,t,e){let s=new WeakMap;return new D(r,_(()=>{let i=t.v;return i.forEach((o,a)=>{let l=s.get(o);l?l.v=a:s.set(o,et(a))}),i}),i=>e(s.get(i),i))}function ct(r){return typeof r=="function"?new P(_(r)):new P(r)}var b;function nt(r){var s;let t=r._Consumer;for(let n of t)if(typeof n!="number"){if(n==b)throw new Error;n._Dirty||(n._Dirty=!0,nt(n))}let e=r._Watchers;e&&(e instanceof Array?e.forEach(n=>{var i;return(i=n._Func)==null?void 0:i.call(n,r)}):(s=e._Func)==null||s.call(e,r))}var x,E=class{constructor(t){this._Consumer=[];v(this,x,void 0);M(this,x,t),this.v=t}get v(){return b&&b._GetCallback(this),y(this,x)}set v(t){if(y(this,x)!=t){M(this,x,t);try{nt(this)}catch(e){throw new Error("Detected cycle in computations.")}}}};x=new WeakMap;function rt(r){if(!(r instanceof m)||!r._Dirty)return;let t=r._Producer;t.length=0;let e=b;b=r;try{r._v=r._Func(),r._Err=void 0}catch(s){r._Err=s}r._Dirty=!1,b=e}var m=class{constructor(t){this._Consumer=[];this._Dirty=!0;this._Producer=[];this._Func=t}_GetCallback(t){let e=t._Consumer;e.indexOf(this)<0&&(e.push(this),this._Producer.push(t))}get v(){if(b&&b._GetCallback(this),rt(this),this._Err)throw this._Err;return this._v}get error(){return this._Err}get computation(){return this._Func}};function st(r){if(!(r instanceof m))return;let t=r._Producer;for(let e of t){let s=e._Consumer.indexOf(r);e._Consumer.splice(s,1),r instanceof m&&!e._Watchers&&e._Consumer.length==0&&st(e)}t.length=0}var j=class{constructor(){this.watchList=new Set}watch(...t){for(let e of t){let s=e._Watchers;if(!s)e._Watchers=this;else if(s instanceof Array){if(s.indexOf(this)>-1)continue;s.push(this)}else s!=this&&(e._Watchers=[this,s]);e instanceof m&&rt(e),this.watchList.add(e)}}unwatch(...t){for(let e of t.length>0?t:this.watchList.values()){let s=e._Watchers;if(s){if(this.watchList.delete(e),s instanceof Array){let n=s.indexOf(this);if(n>-1&&s.splice(n,1),s.length>0)continue}else e._Watchers=void 0;st(e)}}}set callback(t){this._Func=typeof t=="function"?t:void 0}get callback(){return this._Func}};function et(r){return new E(r)}function _(r){return new m(r)}function z(r){let t=new j;return t.callback=r,t}export{m as Compute,lt as ForEach,ft as ForIn,E as State,I as Stop,j as Watcher,_ as compute,ct as dynNode,ht as h,C as makeArr,F as root,et as state,z as watcher};
//# sourceMappingURL=index.js.map
